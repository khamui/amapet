on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      # Setup SSH key
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.VPS_DEPLOY_KEY }}

      # 1️⃣ Create .env file locally
      - name: Create .env file
        run: |
          cat > .env <<EOF
          MONGO_USER="${{ secrets.MONGO_USER }}"
          MONGO_PASSWORD="${{ secrets.MONGO_PASSWORD }}"
          MONGO_DB="${{ secrets.MONGO_DB }}"
          BACKEND_PORT="${{ secrets.BACKEND_PORT }}"
          FRONTEND_PORT="${{ secrets.FRONTEND_PORT }}"
          EOF

      # 2️⃣ Copy project + .env to VPS
      - name: Upload files to VPS
        run: |
          scp -o StrictHostKeyChecking=no -P 2233 \
            .env \
            -r ./ \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/home/${{ secrets.VPS_USER }}/containers/amapet-temp

      # 3️⃣ SSH deploy script
      - name: Deploy on VPS
        run: |
          ssh -o StrictHostKeyChecking=no -p 2233 \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'

          set -e

          # Move into place
          rm -rf /home/${{ secrets.VPS_USER }}/containers/amapet
          mv /home/${{ secrets.VPS_USER }}/containers/amapet-temp /home/${{ secrets.VPS_USER }}/containers/amapet
          cd /home/${{ secrets.VPS_USER }}/containers/amapet

          chmod 600 .env

          echo "Building containers..."
          docker compose build frontend
          docker compose build backend

          echo "Starting containers..."
          docker compose up -d

          echo "Deployment complete."
          EOF
