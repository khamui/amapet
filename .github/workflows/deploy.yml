name: Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # Checkout repository
      # -----------------------------
      - name: Checkout
        uses: actions/checkout@v3

      # -----------------------------
      # Detect changed directories
      # -----------------------------
      - name: Detect changes
        id: changes
        run: |
          FRONTEND_CHANGED="false"
          BACKEND_CHANGED="false"

          if git diff --name-only HEAD~1 HEAD | grep -q '^frontend/'; then
            FRONTEND_CHANGED="true"
          fi

          if git diff --name-only HEAD~1 HEAD | grep -q '^backend/'; then
            BACKEND_CHANGED="true"
          fi

          echo "frontend=$FRONTEND_CHANGED" >> $GITHUB_OUTPUT
          echo "backend=$BACKEND_CHANGED" >> $GITHUB_OUTPUT

      # -----------------------------
      # SSH agent + key
      # -----------------------------
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.VPS_DEPLOY_KEY }}

      # -----------------------------
      # Deploy on server
      # -----------------------------
      - name: Deploy to VPS
        run: |
          ssh -o StrictHostKeyChecking=no \
              -p 2233 \
              ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
              bash << 'SSH_EOF'
          cd /home/${VPS_USER}/containers/helpaws

          cat > .env <<EOF
MONGO_USER="${MONGO_USER}"
MONGO_PASSWORD="${MONGO_PASSWORD}"
MONGO_DB="${MONGO_DB}"
BACKEND_PORT="${BACKEND_PORT}"
FRONTEND_PORT="${FRONTEND_PORT}"
EOF

if [ "$CHANGED_FRONTEND" = "true" ]; then
  echo "Rebuilding frontend"
  docker compose build frontend
fi

if [ "$CHANGED_BACKEND" = "true" ]; then
  echo "Rebuilding backend"
  docker compose build backend
fi

docker compose up -d
SSH_EOF
        env:
          MONGO_USER: ${{ secrets.MONGO_USER }}
          MONGO_PASSWORD: ${{ secrets.MONGO_PASSWORD }}
          MONGO_DB: ${{ secrets.MONGO_DB }}
          BACKEND_PORT: ${{ secrets.BACKEND_PORT }}
          FRONTEND_PORT: ${{ secrets.FRONTEND_PORT }}
          VPS_USER: ${{ secrets.VPS_USER }}
          CHANGED_FRONTEND: ${{ steps.changes.outputs.frontend }}
          CHANGED_BACKEND: ${{ steps.changes.outputs.backend }}
