name: Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # Checkout
      # -----------------------------
      - name: Checkout code
        uses: actions/checkout@v3

      # -----------------------------
      # Detect which services changed
      # -----------------------------
      - name: Detect changes
        id: changes
        run: |
          FRONTEND_CHANGED="false"
          BACKEND_CHANGED="false"

          if git diff --name-only HEAD~1 HEAD | grep -q '^frontend/'; then
            FRONTEND_CHANGED="true"
          fi

          if git diff --name-only HEAD~1 HEAD | grep -q '^backend/'; then
            BACKEND_CHANGED="true"
          fi

          echo "frontend=${FRONTEND_CHANGED}" >> $GITHUB_OUTPUT
          echo "backend=${BACKEND_CHANGED}" >> $GITHUB_OUTPUT

      # -----------------------------
      # Start SSH Agent & load key
      # -----------------------------
      - name: Start SSH agent
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.VPS_DEPLOY_KEY }}

      # -----------------------------
      # Deployment: SSH into VPS
      # -----------------------------
      - name: Deploy over SSH
        run: |
          ssh -o StrictHostKeyChecking=no -p 2233 ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} bash <<'SSH_EOF'
# -----------------------------
# Navigate to your deployment directory
# -----------------------------
cd /home/${VPS_USER}/containers/helpaws

# -----------------------------
# Write .env (correct nested heredoc)
# -----------------------------
cat > .env <<EOF
MONGO_USER="${MONGO_USER}"
MONGO_PASSWORD="${MONGO_PASSWORD}"
MONGO_DB="${MONGO_DB}"
BACKEND_PORT="${BACKEND_PORT}"
FRONTEND_PORT="${FRONTEND_PORT}"
EOF

# -----------------------------
# Rebuild only changed services
# -----------------------------
if [ "$CHANGED_FRONTEND" = "true" ]; then
  echo "Rebuilding FRONTEND…"
  docker compose build frontend
fi

if [ "$CHANGED_BACKEND" = "true" ]; then
  echo "Rebuilding BACKEND…"
  docker compose build backend
fi

# -----------------------------
# Always restart containers
# -----------------------------
docker compose up -d
SSH_EOF
        env:
          # Secrets from GitHub → Sent as env vars during SSH
          MONGO_USER: ${{ secrets.MONGO_USER }}
          MONGO_PASSWORD: ${{ secrets.MONGO_PASSWORD }}
          MONGO_DB: ${{ secrets.MONGO_DB }}
          BACKEND_PORT: ${{ secrets.BACKEND_PORT }}
          FRONTEND_PORT: ${{ secrets.FRONTEND_PORT }}

          # Change detection flags
          CHANGED_FRONTEND: ${{ steps.changes.outputs.frontend }}
          CHANGED_BACKEND: ${{ steps.changes.outputs.backend }}
