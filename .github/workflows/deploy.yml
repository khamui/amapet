name: CI/CD â€” Deploy Amapet

# Trigger on pushes to main
on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # fetch full history for git diff

      - name: Determine changed components
        id: detect_changes
        run: |
          echo "CHANGED_FRONTEND=false" >> $GITHUB_ENV
          echo "CHANGED_BACKEND=false" >> $GITHUB_ENV

          # Determine base commit for diff
          BASE_COMMIT=${{ github.event_before }}

          echo "Base commit: $BASE_COMMIT"

          CHANGED=$(git diff --name-only $BASE_COMMIT HEAD)
          echo "Changed files:"
          echo "$CHANGED"

          if echo "$CHANGED" | grep -q "^frontend/"; then
            echo "CHANGED_FRONTEND=true" >> $GITHUB_ENV
          fi
          if echo "$CHANGED" | grep -q "^backend/"; then
            echo "CHANGED_BACKEND=true" >> $GITHUB_ENV
          fi

      - name: Print changed components
        run: |
          echo "Frontend changed? $CHANGED_FRONTEND"
          echo "Backend changed?  $CHANGED_BACKEND"

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.VPS_DEPLOY_KEY }}

      - name: Deploy changed services
        run: |
          ssh -o StrictHostKeyChecking=no -p 2233 ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} bash << 'SSH_EOF'
            cd /home/${{ secrets.VPS_USER }}/containers/helpaws

# Create .env from GitHub secrets
cat <<EOF > .env
MONGO_USER=${{ secrets.MONGO_USER }}
MONGO_PASSWORD=${{ secrets.MONGO_PASSWORD }}
MONGO_DB=${{ secrets.MONGO_DB }}
BACKEND_PORT=${{ secrets.BACKEND_PORT }}
FRONTEND_PORT=${{ secrets.FRONTEND_PORT }}
EOF

if [ "${CHANGED_FRONTEND}" = "true" ]; then
  docker compose build frontend
fi
if [ "${CHANGED_BACKEND}" = "true" ]; then
  docker compose build backend
fi
# Up only recreates containers that changed
docker-compose up -d frontend backend mongo
SSH_EOF
