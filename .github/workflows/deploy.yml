name: Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Checkout
      - name: Checkout
        uses: actions/checkout@v3

      # Detect changes
      - name: Detect changes
        id: changes
        run: |
          git fetch origin main --depth=2

          FRONTEND_CHANGED="false"
          BACKEND_CHANGED="false"

          if git diff --name-only HEAD~1 HEAD | grep -q '^frontend/'; then
            echo "Frontend changed!"
            FRONTEND_CHANGED="true"
          fi

          if git diff --name-only HEAD~1 HEAD | grep -q '^backend/'; then
            echo "Backend changed!"
            BACKEND_CHANGED="true"
          fi

          echo "frontend=$FRONTEND_CHANGED" >> $GITHUB_OUTPUT
          echo "backend=$BACKEND_CHANGED" >> $GITHUB_OUTPUT

          echo "Frontend changed: $FRONTEND_CHANGED"
          echo "Backend changed: $BACKEND_CHANGED"

      # Setup SSH
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.VPS_DEPLOY_KEY }}

      # Create .env inside deployment/
      - name: Create .env
        run: |
          mkdir -p deployment
          cat > deployment/.env <<EOF
          MONGO_USER="${{ secrets.MONGO_USER }}"
          MONGO_PASSWORD="${{ secrets.MONGO_PASSWORD }}"
          MONGO_DB="${{ secrets.MONGO_DB }}"
          BACKEND_PORT="${{ secrets.BACKEND_PORT }}"
          FRONTEND_PORT="${{ secrets.FRONTEND_PORT }}"
          EOF

      # Upload files to VPS (deployment/, frontend/, backend/)
      - name: Upload to VPS
        run: |
          ssh -o StrictHostKeyChecking=no -p 2233 \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            "rm -rf /home/${{ secrets.VPS_USER }}/containers/amapet-temp && mkdir -p /home/${{ secrets.VPS_USER }}/containers/amapet-temp"

          scp -o StrictHostKeyChecking=no -P 2233 -r \
            deployment frontend backend \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/home/${{ secrets.VPS_USER }}/containers/amapet-temp

      # Deploy on VPS
      - name: Deploy on VPS
        run: |
          ssh -o StrictHostKeyChecking=no -p 2233 \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << EOF

          set -e

          cd /home/${{ secrets.VPS_USER }}/containers

          rm -rf amapet
          mv amapet-temp amapet
          cd amapet/deployment

          chmod 600 .env

          if [ "${{ steps.changes.outputs.frontend }}" = "true" ]; then
            echo "Rebuilding frontend"
            docker compose build frontend
          fi

          if [ "${{ steps.changes.outputs.backend }}" = "true" ]; then
            echo "Rebuilding backend"
            docker compose build backend
          fi

          docker compose up -d

          echo "Deployment complete."
          EOF

