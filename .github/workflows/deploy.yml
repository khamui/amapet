name: Deploy

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # Checkout repository
      # -----------------------------
      - name: Checkout
        uses: actions/checkout@v3

      # -----------------------------
      # Detect changed directories
      # -----------------------------
      - name: Detect changes
        id: changes
        run: |
          FRONTEND_CHANGED="false"
          BACKEND_CHANGED="false"

          if git diff --name-only HEAD~1 HEAD | grep -q '^frontend/'; then
            FRONTEND_CHANGED="true"
          fi

          if git diff --name-only HEAD~1 HEAD | grep -q '^backend/'; then
            BACKEND_CHANGED="true"
          fi

          echo "frontend=$FRONTEND_CHANGED" >> $GITHUB_OUTPUT
          echo "backend=$BACKEND_CHANGED" >> $GITHUB_OUTPUT

      # -----------------------------
      # SSH agent + key
      # -----------------------------
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.VPS_DEPLOY_KEY }}

      # -----------------------------
      # Create .env locally in GitHub runner
      # -----------------------------
      - name: Create .env
        run: |
          cat > .env <<EOF
          MONGO_USER="${{ secrets.MONGO_USER }}"
          MONGO_PASSWORD="${{ secrets.MONGO_PASSWORD }}"
          MONGO_DB="${{ secrets.MONGO_DB }}"
          BACKEND_PORT="${{ secrets.BACKEND_PORT }}"
          FRONTEND_PORT="${{ secrets.FRONTEND_PORT }}"
          EOF

      # -----------------------------
      # Upload repository + .env to VPS using SCP
      # -----------------------------
      - name: Upload to VPS
        run: |
          # Create temp deploy folder on server
          ssh -o StrictHostKeyChecking=no -p 2233 \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            "rm -rf /home/${{ secrets.VPS_USER }}/containers/amapet-temp && mkdir -p /home/${{ secrets.VPS_USER }}/containers/amapet-temp"

          # Upload repository
          scp -o StrictHostKeyChecking=no -P 2233 -r ./* \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/home/${{ secrets.VPS_USER }}/containers/amapet-temp

          # Upload .env
          scp -o StrictHostKeyChecking=no -P 2233 .env \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/home/${{ secrets.VPS_USER }}/containers/amapet-temp/.env

      # -----------------------------
      # Execute deployment on VPS
      # -----------------------------
      - name: Deploy on VPS
        run: |
          ssh -o StrictHostKeyChecking=no -p 2233 \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << EOF

          set -e

          cd /home/${{ secrets.VPS_USER }}/containers

          # Replace old deployment with new files
          rm -rf amapet
          mv amapet-temp amapet
          cd amapet

          chmod 600 .env

          # Conditional rebuilds
          if [ "${{ steps.changes.outputs.frontend }}" = "true" ]; then
            echo "Rebuilding frontend"
            docker compose build frontend
          fi

          if [ "${{ steps.changes.outputs.backend }}" = "true" ]; then
            echo "Rebuilding backend"
            docker compose build backend
          fi

          # Restart containers
          echo "Starting containers..."
          docker compose up -d

          echo "Deployment complete."
          EOF
